#!/usr/bin/env bash
#
# LuxeOS (c) 2023 by Jozef Nagy
#
# LuxeOS is licensed under a
# Creative Commons Attribution-NoDerivatives 4.0 International License.
#
# You should have received a copy of the license along with this
# work. If not, see <http://creativecommons.org/licenses/by-nd/4.0/>.
#
#

function make_write {
	printf "%s\n" "$@" >> Makefile.in
}

## TODO: Allow to configure custom build and release directories

# Download submodules
git submodule update --init 1> /dev/null

if [ ! -f ".config" ]; then
	ex/kconfiglib/alldefconfig.py
fi

if [ ! -f "krnl/config.h" ]; then
	ex/kconfiglib/genconfig.py --header-path krnl/config.h
fi

make -C ex/limine

build_dir="build"
release_dir="release"

########################################
### X86_64
########################################

x86_64_cflags="-m64 -march=x86-64 -mno-80387 -mno-mmx -mno-sse -mno-sse2 -mno-red-zone"
x86_64_ldflags="-melf_x86_64"
x86_64_asflags="-felf64"

x86_64_qemuflags="-M q35 -m 1G -serial stdio -no-reboot -no-shutdown -cdrom \$(RELEASE_ISO) -bios aux/ovmf-\$(ARCH).fd"

########################################
### AARCH64
########################################

aarch64_cflags="-mgeneral-regs-only"
aarch64_ldflags="-maarch64elf"

aarch64_qemuflags="-M virt -m 1G -cpu cortex-a72 -device ramfb -device qemu-xhci -device usb-kbd -cdrom \$(RELEASE_ISO) -bios aux/ovmf-\$(ARCH).fd"

########################################
### GENERAL
########################################

cflags="-Wall -Wextra -std=c99 -ffreestanding -fno-stack-protector -fno-stack-check -fno-lto -fPIE"
cppflags="\$(INCDIR:%=-I%) -MMD -MP"
ldflags="-nostdlib -static -pie --no-dynamic-linker -ztext -zmax-page-size=0x1000 -T aux/linker-\$(ARCH).ld"

echo -e "# This file has been generated by ./configure. Do not change this file." > Makefile.in
make_write "#"
make_write "#"
make_write "# LuxeOS (c) 2023 by Jozef Nagy"
make_write "#"
make_write "# LuxeOS is licensed under a"
make_write "# Creative Commons Attribution-NoDerivatives 4.0 International License."
make_write "#"
make_write "# You should have received a copy of the license along with this"
make_write "# work. If not, see <http://creativecommons.org/licenses/by-nd/4.0/>."
make_write "#"
make_write "#"
make_write ""
make_write "include .config"
make_write ""
make_write "ifeq (\$(CONFIG_X86_64),y)"
make_write "	ARCH := x86_64"
make_write "else ifeq (\$(CONFIG_AARCH64),y)"
make_write "	ARCH := aarch64"
make_write "endif"
make_write ""
make_write "GIT_REVISION := \$(shell git rev-parse --short HEAD)"
make_write ""
make_write "BUILD_DIR := $build_dir"
make_write "KERNEL := \$(BUILD_DIR)/krnl.sys"
make_write ""
make_write "RELEASE_DIR := $release_dir"
make_write "RELEASE_ISO := \$(RELEASE_DIR)/luxe-cd-\$(GIT_REVISION)_\$(ARCH).iso"
make_write "RELEASE_HDD := \$(RELEASE_DIR)/luxe-hdd-\$(GIT_REVISION)_\$(ARCH).img"
make_write ""
make_write "INCDIR := krnl krnl/corelib krnl/arch/\$(ARCH)"
make_write ""
make_write "ifeq (\$(CONFIG_X86_64),y)"
make_write "	PREFIX := x86_64-elf"
make_write "	AS := nasm"
make_write "	ASFLAGS := $x86_64_asflags"
make_write "	CFLAGS := $x86_64_cflags"
make_write "	LDFLAGS := $x86_64_ldflags"
make_write "	QEMUFLAGS := $x86_64_qemuflags"
make_write "	EFI_BOOTFILE := BOOTX64.EFI"
make_write "else ifeq (\$(CONFIG_AARCH64),y)"
make_write "	ARCH := aarch64"
make_write "	PREFIX := aarch64-elf"
make_write "	CFLAGS := $aarch64_cflags"
make_write "	LDFLAGS := $aarch64_ldflags"
make_write "	QEMUFLAGS := $aarch64_qemuflags"
make_write "	EFI_BOOTFILE := BOOTAA64.EFI"
make_write "endif"
make_write ""
make_write "ifeq (\$(CONFIG_DEBUG),y)"
make_write "	CFLAGS += -g"
make_write "	ASFLAGS += -g"
make_write "	LDFLAGS += -g"
make_write "endif"
make_write ""
make_write "CC := \$(PREFIX)-gcc"
make_write "LD := \$(PREFIX)-ld"
make_write "OBJCOPY := \$(PREFIX)-objcopy"
make_write "QEMU := qemu-system-\$(ARCH)"
make_write ""
make_write "CFLAGS += $cflags"
make_write "CPPFLAGS += $cppflags"
make_write "LDFLAGS += $ldflags"
make_write ""
make_write "ARCH_C_FILES := \$(shell find krnl/corelib/luxe/\$(ARCH) krnl/arch/\$(ARCH) -name *.c -type f)"
make_write "ARCH_AS_FILES := \$(shell find krnl/corelib/luxe/\$(ARCH) krnl/arch/\$(ARCH) -name *.asm -type f)"
make_write ""
make_write "C_FILES := \$(shell find krnl -name "*.c" -not -path \"*/arch/*\" -not -path \"krnl/corelib/luxe/x86_64\" -not -path \"krnl/corelib/luxe/aarch64\" -type f)"
make_write "AS_FILES := \$(shell find krnl -name "*.asm" -not -path \"*/arch/*\" -not -path \"krnl/corelib/luxe/x86_64\" -not -path \"krnl/corelib/luxe/aarch64\" -type f)"
make_write ""
make_write "OBJ := \$(C_FILES:%.c=\$(BUILD_DIR)/%.o) \$(ARCH_C_FILES:%.c=\$(BUILD_DIR)/%.o) \$(AS_FILES:%.asm=\$(BUILD_DIR)/%.o) \$(ARCH_AS_FILES:%.asm=\$(BUILD_DIR)/%.o)"